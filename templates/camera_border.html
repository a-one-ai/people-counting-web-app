<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='Home.css') }}" />
</head>
<body>

    <div class = "rectangle">

    <p class="second-page-parag-border">Camera Name {{ gateNameInput }}</p>
    <img src="static\icon.ico" style="height: 100%; width: 7%" id="homeButton" />


    </div>
    <div class="block_img_btn">
        <canvas id="outputCanvas" width="700" height="500"></canvas>
        <p>Count: <span id="countValue"></span></p>

       
       
    </div>

    <script>
        var goBackToHome = function () {
            window.location.href = "/";
        };
    
        // Click event handler for the home button
        document.getElementById('homeButton').addEventListener('click', function () {
            goBackToHome();
        });
    




        const ip = "{{ ip }}";
        let video = document.createElement('video');
        document.body.appendChild(video);
        video.hidden = true;
        window.onload = () => startStream('');

        let inputCanvas = document.createElement('canvas');
        document.body.appendChild(inputCanvas);
        inputCanvas.style.display = 'none';

        let outputCanvas = document.getElementById('outputCanvas');
        let outputContext = outputCanvas.getContext('2d');
        let sendInterval = 200;
        let stopped = false;

        function startStream() {
            startVideo()
                .then(() => {
                    setInterval(function () {
                        if (stopped) {
                            return;
                        }

                        inputCanvas.width = video.videoWidth;
                        inputCanvas.height = video.videoHeight;
                        let inputContext = inputCanvas.getContext('2d');
                        inputContext.drawImage(video, 0, 0, inputCanvas.width, inputCanvas.height);
                        let imgData = inputCanvas.toDataURL('image/jpeg');

                        fetch('/process_frame_border', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ frame: imgData, ip: ip })  // Include 'ip' in the request body
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data && data.processed_frame) {
                                    let processedImage = new Image();
                                    processedImage.onload = function () {
                                        outputContext.drawImage(processedImage, 0, 0, 640, 480);
                                    };
                                    processedImage.src = 'data:image/jpeg;base64,' + data.processed_frame;

                                    // Update the count value in the HTML
                                    if (data.count !== undefined) {
                                        document.getElementById('countValue').innerText = data.count;
                                    }
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                            });
                    }, sendInterval);
                })
                .catch(error => {
                    console.error('Error starting video:', error);
                });
        }
        function startVideo() {
            return new Promise((resolve, reject) => {
                if (navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ video: true })
                        .then(function (stream) {
                            video.srcObject = stream;
                            video.play();
                            resolve();
                        })
                        .catch(function (error) {
                            reject(error);
                        });
                } else {
                    reject(new Error('getUserMedia is not supported in this browser.'));
                }
            });
        }
        function stopStream() {
            stopped = true;
            let tracks = video.srcObject.getTracks();

            tracks.forEach(track => track.stop());
            video.srcObject = null;
            outputContext.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
        }
      

      
    </script>
</body>
</html>
