<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"></script>

    <link rel="stylesheet" href="{{ url_for('static', filename='Home.css') }}" />
</head>
<body>
    <div class = "rectangle">

    <p class="second-page-parag-border">Draw Your Virtual Gate For {{ gateNameInput }}</p>
    <img src="static\icon.ico" style="height: 100%; width: 7%" id="homeButton" />

    </div>
    <div class="block_img_btn">
        <canvas id="outputCanvas" width="700" height="500"></canvas>

        <div class="buttons-container">
            <button class="button" id="stopButton">Stop Stream</button>
            <button class="button" id="startButton">Start Stream</button>
            <p class="click">Click on the video to get coordinates:</p>
            <p class="click">Coordinates: <span id="clickedPoint"></span></p>
        </div>
    </div>

    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {getFirestore, collection, addDoc, serverTimestamp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"; 

        const firebaseConfig = {
            apiKey: "AIzaSyBp1-XkxPN_8A2P0eN1zvfZn2UmK67m0PM",
            authDomain: "borders-6mmmsha.firebaseapp.com",
            projectId: "borders-6mmmsha",
            storageBucket: "borders-6mmmsha.appspot.com",
            messagingSenderId: "921502256532",
            appId: "1:921502256532:web:cfa32a4aea85e7ebadd381",
            measurementId: "G-DQJ79K7Q3M"
            };
    
    
            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            const storage = getStorage(app);
            
            
        var goBackToHome = function () {
            window.location.href = "/";
        };
    
        // Click event handler for the home button
        document.getElementById('homeButton').addEventListener('click', function () {
            goBackToHome();
        });
    




        const ip = "{{ ip }}";
        var gate_name = "{{gateNameInput}}";
        let video = document.createElement('video');
        document.body.appendChild(video);
        video.hidden = true;

        window.onload = () => startStream('');


        let inputCanvas = document.createElement('canvas');
        document.body.appendChild(inputCanvas);
        inputCanvas.style.display = 'none';

        let outputCanvas = document.getElementById('outputCanvas');
        let outputContext = outputCanvas.getContext('2d');
        let sendInterval = 200;
        let stopped = false;

        function startStream() {
            startVideo()
                .then(() => {
                    setInterval(function () {
                        if (stopped) {
                            return;
                        }
                        const storageRef = ref(storage, `image_${Date.now()}.jpg`);


                        inputCanvas.width = video.videoWidth;
                        inputCanvas.height = video.videoHeight;
                        let inputContext = inputCanvas.getContext('2d');
                        inputContext.drawImage(video, 0, 0, inputCanvas.width, inputCanvas.height);
                        let imgData = inputCanvas.toDataURL('image/jpeg');

                        fetch('/process_frame', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ frame: imgData, ip: ip, gate_name:gate_name })  // Include 'ip' in the request body
                        })
                            .then(response => response.json())
                            .then( async (data) => {
                                if (data && data.processed_frame) {
                                    let processedImage = new Image();
                                    processedImage.onload = function () {
                                        outputContext.drawImage(processedImage, 0, 0, 640, 480);
                                    };
                                    processedImage.src = 
                                        'data:image/jpeg;base64,' + data.processed_frame;
                                

                                    let base64ImageData = processedImage.src.split(',')[1];  // Extract only the base64 part

                                    const blob = await fetch(`data:image/jpeg;base64,${base64ImageData}`).then(res => res.blob());

                                    const storageRef = ref(storage, `${gate_name}/${gate_name}_${Date.now()}.jpg`);
                            
                                    await uploadBytes(storageRef, blob);
                            
                                    const imageUrl = await getDownloadURL(storageRef);
                            
                                    await addDoc(collection(firestore, gate_name), {
                                        loginTime: serverTimestamp(),
                                        currentscene: imageUrl
                                    })
                                }
                            })
                        } , 30000);
                    })};


                    
        function startVideo() {
            return new Promise((resolve, reject) => {
                if (navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ video: true })
                        .then(function (stream) {
                            video.srcObject = stream;
                            video.play();
                            resolve();
                        })
                        .catch(function (error) {
                            reject(error);
                        });
                } else {
                    reject(new Error('getUserMedia is not supported in this browser.'));
                }
            });
        }


        function stopStream() {
            stopped = true;
            let tracks = video.srcObject.getTracks();

            tracks.forEach(track => track.stop());
            video.srcObject = null;
            outputContext.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
        }

        document.getElementById('startButton').addEventListener('click', startStream);
        document.getElementById('stopButton').addEventListener('click', stopStream);

        let clickedPointDisplay = document.getElementById('clickedPoint');
        outputCanvas.addEventListener('mousedown', function (event) {
            if (stopped) {
                return;
            }

            let rect = outputCanvas.getBoundingClientRect();
            let x = event.clientX - rect.left;
            let y = event.clientY - rect.top;

            clickedPointDisplay.textContent = `X: ${x}, Y: ${y}`;

            fetch('/mouse_event', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ x: x, y: y, ip: ip })  // Send 'ip' along with the coordinates
            })
                .then(response => response.json())
                .then(data => {
                    // Handle response from Flask if needed
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });
    </script>
</body>
</html>
