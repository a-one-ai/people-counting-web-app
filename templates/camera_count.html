<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='Home.css') }}" />
</head>
<body>
    <div class = "rectangle">

    <p class="second-page-parag">Draw Your Virtual Gate For {{ gateNameInput }}</p>
    
    </div>
    <div class="block_img_btn">
        <canvas id="outputCanvas" width="700" height="500"></canvas>

        <div class="buttons-container">
            <button class="button" id="stopButton">Stop Stream</button>
            <button class="button" id="startButton">Start Stream</button>
            <p class="click">Click on the video to get coordinates:</p>
            <p class="click">Coordinates: <span id="clickedPoint"></span></p>
        </div>
    </div>

    <script>
        const ip = "{{ ip }}";
        let video = document.createElement('video');
        document.body.appendChild(video);
        video.hidden = true;

        let inputCanvas = document.createElement('canvas');
        document.body.appendChild(inputCanvas);
        inputCanvas.style.display = 'none';

        let outputCanvas = document.getElementById('outputCanvas');
        let outputContext = outputCanvas.getContext('2d');
        let sendInterval = 200;
        let stopped = false;

        function startStream() {
            startVideo()
                .then(() => {
                    setInterval(function () {
                        if (stopped) {
                            return;
                        }

                        inputCanvas.width = video.videoWidth;
                        inputCanvas.height = video.videoHeight;
                        let inputContext = inputCanvas.getContext('2d');
                        inputContext.drawImage(video, 0, 0, inputCanvas.width, inputCanvas.height);
                        let imgData = inputCanvas.toDataURL('image/jpeg');

                        fetch('/process_frame', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ frame: imgData, ip: ip })  // Include 'ip' in the request body
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data && data.processed_frame) {
                                    let processedImage = new Image();
                                    processedImage.onload = function () {
                                        outputContext.drawImage(processedImage, 0, 0, 640, 480);
                                    };
                                    processedImage.src = 'data:image/jpeg;base64,' + data.processed_frame;
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                            });
                    }, sendInterval);
                })
                .catch(error => {
                    console.error('Error starting video:', error);
                });
        }

        function startVideo() {
            return new Promise((resolve, reject) => {
                if (navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ video: true })
                        .then(function (stream) {
                            video.srcObject = stream;
                            video.play();
                            resolve();
                        })
                        .catch(function (error) {
                            reject(error);
                        });
                } else {
                    reject(new Error('getUserMedia is not supported in this browser.'));
                }
            });
        }

        function stopStream() {
            stopped = true;
            let tracks = video.srcObject.getTracks();

            tracks.forEach(track => track.stop());
            video.srcObject = null;
            outputContext.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
        }

        document.getElementById('startButton').addEventListener('click', startStream);
        document.getElementById('stopButton').addEventListener('click', stopStream);

        let clickedPointDisplay = document.getElementById('clickedPoint');
        outputCanvas.addEventListener('mousedown', function (event) {
            if (stopped) {
                return;
            }

            let rect = outputCanvas.getBoundingClientRect();
            let x = event.clientX - rect.left;
            let y = event.clientY - rect.top;

            clickedPointDisplay.textContent = `X: ${x}, Y: ${y}`;

            fetch('/mouse_event', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ x: x, y: y, ip: ip })  // Send 'ip' along with the coordinates
            })
                .then(response => response.json())
                .then(data => {
                    // Handle response from Flask if needed
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });
    </script>
</body>
</html>
